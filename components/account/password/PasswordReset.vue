<script setup lang="ts">
import { useVuelidate } from '@vuelidate/core';
import { minLength, required, sameAs } from '@vuelidate/validators';
import { set } from '@vueuse/core';
import { type Ref } from 'vue';
import { FetchError } from 'ofetch';
import { fetchWithCsrf } from '~/utils/api';

function setupTokenValidation() {
  const route = useRoute();
  const { uid, token } = route.params;
  const validating = ref(true);
  const isValid = ref(true);

  const validateToken = async () => {
    try {
      await fetchWithCsrf<void>('/webapi/password-reset/validate/', {
        method: 'post',
        body: {
          uid,
          token,
        },
      });
    } catch (e: any) {
      if (!(e instanceof FetchError && e.status === 404)) {
        logger.error(e);
      }
      set(isValid, false);
    } finally {
      set(validating, false);
    }
  };

  onMounted(async () => await validateToken());
  return { validating, isValid };
}

function setupFormValidation(
  password: Ref<string>,
  passwordConfirmation: Ref<string>,
  $externalResults: Ref<NonNullable<unknown>>,
) {
  const rules = {
    password: { required, minLength: minLength(8) },
    passwordConfirmation: {
      required,
      sameAsPassword: sameAs(password, 'password'),
    },
  };

  const v$ = useVuelidate(
    rules,
    { password, passwordConfirmation },
    {
      $autoDirty: true,
      $externalResults,
    },
  );

  const valid = computed(() => !v$.value.$invalid);
  return { v$, valid };
}

const password = ref('');
const passwordConfirmation = ref('');
const $externalResults = ref({});

const route = useRoute();
const { uid, token } = route.params;
const submit = async () => {
  try {
    await fetchWithCsrf<void>('/webapi/password-reset/confirm/', {
      method: 'post',
      body: {
        uid,
        token,
        password: password.value,
        password_confirmation: passwordConfirmation.value,
      },
    });
    await navigateTo({
      path: '/password/changed',
    });
  } catch (e: any) {
    if (e instanceof FetchError && e.status === 400) {
      const message = e.data.message;
      if (message && typeof message === 'object') {
        $externalResults.value = {
          password: message.password,
          passwordConfirmation: message.password_confirmation,
        };
      }
    } else {
      logger.error(e);
    }
  }
};

const { validating, isValid } = setupTokenValidation();
const { valid, v$ } = setupFormValidation(
  password,
  passwordConfirmation,
  $externalResults,
);

const css = useCssModule();
</script>

<template>
  <PageContainer>
    <template #title> Reset your password </template>

    <div :class="css.content">
      <LoadingIndicator v-if="validating" />
      <UserActionMessage v-else-if="!isValid">
        <template #header>Invalid password reset link.</template>
        <p>
          The link you followed doesn't seem like a valid password reset link.
        </p>
      </UserActionMessage>
      <BoxContainer v-else>
        <template #label> Provide your new password </template>
        <InputField
          id="password"
          v-model="password"
          :error-messages="v$.password.$errors"
          filled
          label="Password"
          autocomplete="new-password"
          type="password"
        >
          <ul :class="css.list">
            <li>
              Your password can't be too similar to your other personal
              information.
            </li>
            <li>Your password must contain at least 8 characters.</li>
            <li>Your password can't be a commonly used password.</li>

            <li>Your password can't be entirely numeric.</li>
          </ul>
        </InputField>

        <InputField
          id="password-confirmation"
          v-model="passwordConfirmation"
          :class="css.confirmation"
          :error-messages="v$.passwordConfirmation.$errors"
          filled
          hint="Enter the same password as before, for verification."
          label="Password Confirmation"
          type="password"
          autocomplete="new-password"
        />
        <div :class="css.buttonWrapper">
          <ActionButton
            :class="css.button"
            :disabled="!valid"
            primary
            small
            text="Submit"
            @click="submit()"
          />
        </div>
      </BoxContainer>
    </div>
  </PageContainer>
</template>

<style lang="scss" module>
.button {
  @apply mt-16;
}

.buttonWrapper {
  @apply flex flex-row align-middle justify-center;
}

.subtitle {
  @apply text-rui-text font-medium text-center uppercase text-xs;
}

.list {
  @apply text-xs list-disc pl-6 text-rui-text-secondary;
}

.box {
  @apply border p-6 rounded w-full lg:w-96;
}

.label {
  @apply text-rui-grey-800 mb-4 text-lg;
}

.confirmation {
  @apply mt-2;
}

.content {
  @apply flex flex-row justify-center;
}
</style>
