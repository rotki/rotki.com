<script setup lang="ts">
import { get, set } from '@vueuse/core';
import detectEthereumProvider from '@metamask/detect-provider';
import { type CryptoPayment, type PaymentStep, type Provider } from '~/types';
import { useMainStore } from '~/store';
import { assert } from '~/utils/assert';

const loading = ref(false);
const data = ref<CryptoPayment | null>(null);
const metamaskSupport = ref(false);

const { cryptoPayment, switchCryptoPlan } = useMainStore();
const { plan } = usePlanParams();
const { currency } = useCurrencyParams();
const { subscriptionId } = useSubscriptionIdParam();

let provider: Provider | null = null;

onMounted(async () => {
  const selectedPlan = get(plan);
  const selectedCurrency = get(currency);
  if (selectedPlan > 0 && selectedCurrency) {
    provider = await detectEthereumProvider();
    logger.debug(
      `provider: ${!!provider}, is metamask: ${provider?.isMetaMask}`
    );
    set(metamaskSupport, !!provider);
    set(loading, true);
    const subId = get(subscriptionId);
    const result = await cryptoPayment(selectedPlan, selectedCurrency, subId);
    if (result.isError) {
      set(error, result.error.message);
    } else if (result.result.transactionStarted) {
      await navigateTo('/home');
    } else {
      set(data, result.result);
    }

    set(loading, false);
  } else {
    await navigateTo('/products');
  }
});

const step = computed<PaymentStep>(() => {
  const errorMessage = get(error);
  const state = get(currentState);
  if (errorMessage) {
    return {
      type: 'failure',
      title: 'Payment Failure',
      message: errorMessage,
      closeable: true,
    };
  } else if (state === 'pending') {
    return {
      type: 'pending',
      title: 'Payment in Progress',
      message: 'Please confirm your transaction...',
    };
  } else if (state === 'success') {
    return {
      type: 'success',
      title: 'Transaction Pending',
      message:
        'You should receive an e-mail confirming the activation of your subscription in the near future.',
    };
  }
  return { type: 'idle' };
});

const reset = () => {
  set(currentState, 'idle');
  set(error, '');
};

const config = useRuntimeConfig();
const {
  payWithMetamask,
  state: currentState,
  error,
} = useWeb3Payment(
  data,
  () => {
    assert(provider);
    return provider;
  },
  !!config.testing
);

watch(plan, async (plan) => {
  const selectedCurrency = get(currency);
  assert(selectedCurrency);
  const response = await switchCryptoPlan(
    plan,
    selectedCurrency,
    get(subscriptionId)
  );
  if (!response.isError) {
    set(data, response.result);
  } else {
    set(error, response.error.message);
  }
});

const css = useCssModule();
</script>

<template>
  <PaymentFrame :loading="loading" :step="step" @close="reset">
    <template #description>
      <div :class="css.description">
        Payments by crypto can have slower processing times.
      </div>
    </template>
    <div :class="css.row">
      <div>
        <CryptoPaymentForm
          v-if="data"
          :data="data"
          :plan="plan"
          :metamask-support="metamaskSupport"
          @pay="payWithMetamask"
        />
      </div>
    </div>
  </PaymentFrame>
</template>

<style lang="scss" module>
@import '@/assets/css/media.scss';

.description {
  max-width: 600px;

  @include text-size(18px, 21px);
}
</style>
